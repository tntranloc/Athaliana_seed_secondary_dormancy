#dataframe for pdorm, sdorm, and control
#germinated, non germinated, germination rate, together with: Latitude, Longitude, Admixture, Iso alpha, Genotype, AccessionID

#in control, subset those with germination rate equal or greater than 0.7 
good = control[control['germination rate'] >= 0.7]
include_id = list(good['ID'])

#include only those in pdorm, sdorm
pdorm_good = pdorm[pdorm['ID'].isin(include_id)]
sdorm_good = sdorm[sdorm['ID'].isin(include_id)]


#############################OR do this in R#########################

#in control, subset those with germination rate equal or greater than 0.7 
good = subset(control, germination_rate <= 0.7)
include_id = good$ID

#include only those in pdorm, sdorm
pdorm_good = subset(pdorm, ID %in% include_id)
sdorm_good = subset(sdorm, ID %in% include_id)

##########################GET CLIMATIC DATA IN R##########################

library(sp)

install.packages('terra', repos='https://rspatial.r-universe.dev') #need to tell R not to compile terra
#without this, error may happen when loading raster package

library(raster) #to have getData function

biocur = getData("worldclim",var="bio",res=10) #to get data from WorldClim #resolution 10km
summary(biocur)
gain(biocur) #check the gain, f.e. temperature gain = 0.1 means meaning that it must be multipled by 0.1 to convert back to degrees Celsius.

#here are four representative concentration pathways (RCPs) 
#describing different climate futures depending on the emitted volumes of greenhouse gases.
#using RCP 4.5 here, which assumes a peak decline in green house gases around 2040, 
#followed by decreasing emission. This is a rather optimistic scenario.

biofut = getData('CMIP5', var='bio', res=10, rcp=45, model='NO', year=50, download=T)
summary(biofut)

#define your extent #lon, lat
e = extent(..,..,..,..)
biocur_df = raster::extract(biocur[[1:19]],e, df=T)

#or only extract those in your dataframe
xy = good[,c(lon,lat)] #define your xy coordinates, NOTE THAT!! longitude =x and latitude =y
spdf = SpatialPointsDataFrame(coords = xy, data = df,
                               proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))

#Extract data from biocur using a SpatialPoints object 
#here took all 19 climatic variables
biocur_df = raster::extract(biocur[[1:19]],spdf,df=T) 
divide bio1 to bio11 by 10!!

write.csv(biocur_df, 'biocur.csv')


##############Combine data##############
#combine dataframes, I will neeed 2 kinds of formats
#one has columns treatment, germ, non germ, germ rate, lon, lat, bio...
#the other has columns control, pdorm, sdorm (values are germ rate), lon, lat, bio9

###Type 1
good_biocur = cbind(good, biocur)
pdorm_biocur = cbind(pdorm_good, biocur)
sdorm_biocur = cbind(sdorm_good, biocur)
all_good_1_biocur = rbind(good_biocur, pdorm_biocur, sdorm_biocur)


###Type 2
t1 = data.frame(pdorm_good$germrate,sdorm_good$germrate,good$germrate, good$lon, good$lat, good$iso_alpha)
all_good_2_biocur = cbind(t1, biocur)



##############OR I would go to python, for example: ##############
good_biocur = pd.concat([good, biocur], axis = 1)
pdorm_biocur = pd.concat([pdorm, biocur], axis = 1)
sdorm_biocur = pd.concat([sdorm, biocur], axis = 1)


all_good_1_biocur = pd.concat([good_biocur, pdorm_biocur, sdorm_biocur]).reset_index(drop=True)



#################################################################PLOT FIRST, I use Plotly Python#######################################

#use all_good_2_biocur

import plotly
import plotly.express as px
import os
import pandas as pd

import statsmodels as statmod
import numpy as np
import scipy as sp
import patsy 

#visualise the samples on geographical maps

fig8 = px.scatter_mapbox(df1, lat="Latitude", lon="Longitude", color = "Origin",
                  color_discrete_sequence = px.colors.qualitative.Safe, zoom=3,
                         hover_name = "Genotype", 
                         hover_data = ["Latitude","Longitude","bio9","bio10","bio18","sdorm","pdorm"],
                        center={"lat": 54.5, "lon": 15.2},
                  mapbox_style="carto-positron") #can choose something else, check plotly


#pdorm and sdorm against latitude

fig_plat = px.scatter(df1, x='Latitude',y='pdorm',symbol = 'Origin',color = 'Origin', #symbol and colour by countries
                 trendline = 'ols', trendline_scope = 'overall',
                  template = "simple_white",
                color_discrete_sequence = px.colors.qualitative.Safe,
                labels={"pdorm": "Primary dormancy (germination rate)"}
                        )

fig_slat = px.scatter(df1, x='Latitude',y='sdorm',symbol = 'Origin',color = 'Origin',
                 trendline = 'ols', trendline_scope = 'overall',
                  template = "simple_white",
                color_discrete_sequence = px.colors.qualitative.Safe,
                labels={"sdorm": "Secondary dormancy (germination rate)"}
                )
                
                
#pdorm and sdorm correlation

fig_ps_origin = px.scatter(df1, x='pdorm',y='sdorm',color = 'Origin', symbol = 'Origin', #colour by countries
                  hover_name = "Origin", hover_data = ["bio9","Latitude"],
                 trendline = 'ols', trendline_scope = 'overall',template = "simple_white",
                color_discrete_sequence = px.colors.qualitative.Safe,
                labels={"pdorm": "Primary dormancy (germination rate)",
                        "sdorm": "Secondary dormancy (germination rate)",
                       "bio9":"BIO9"}
                        )
                        
fig_ps_bio9 = px.scatter(df1, x='pdorm',y='sdorm',color = 'bio9', hover_name = "Origin", 
                  hover_data = ["bio9","Latitude","Longitude"],
                 trendline = 'ols', template = "simple_white",
                color_continuous_scale = 'amp',
                labels={"pdorm": "Primary dormancy (germination rate)",
                        "sdorm": "Secondary dormancy (germination rate)",
                       "bio9":"BIO9"}
                        )                        
 fig_ps_lat = px.scatter(df1, x='pdorm',y='sdorm',color = 'Latitude', hover_name = "Origin", hover_data = ["bio9","Latitude"], #colour by latitude
                 trendline = 'ols', template = "simple_white",
                color_continuous_scale = 'deep',
                labels={"pdorm": "Primary dormancy (germination rate)",
                        "sdorm": "Secondary dormancy (germination rate)",
                       "bio9":"BIO9"}
                 )                       


#customise your plot
fig.update_layout(
    font=dict(
        family="Times New Roman",
        size=16
    )
)

#save your plot 
fig.write_html("myplot.html")


###########Sliding window##############
see sliding_window script

#############################################GENERALISED LINEAR MODEL (in R)#####################################
##We want to know which ecological variables influence the dormancy, 
#binomial model should fit our purpose

#use all_good_1_biocur

summary(all_good_1_biocur)    #check if treatments (and Origin) is as factor
#convert temperature unit to celsius, worldclim has multiple everything by 10#check the distribution of the data
plot(density(all_good_1_biocur$Germination_rate))   
#create matrix of germinated vs non germinated value
all_good_1_biocur$Group <- factor(all_good_1_biocur$Group, levels=c("primary_dormancy","Secondary_dormancy","4degree"))
all_good_1_biocur$Origin <- factor(all_good_1_biocur$Origin)
mat<-cbind(all_good_1_biocur$Germinated,all_good_1_biocur$Non_germinated)
head(mat)
summary(mat)
mat<-as.matrix(mat)
colnames(mat)<-c("germ","ngerm")

#run glm model for each factor 
mod1 = glm(mat ~ bio1*Group,
            family = "quasibinomial", data = dorm)  #same if you use the matrix
summary(mod1)

library(jtools) #for summ()
summ(mod1, confint = TRUE, exp = T, digits = 4)
anova(mod1, test = "F")

#write a loop to check all BIO factors
i=9
for (i in 9:27) {
  print(colnames(dorm)[i])
  mymod=glm(mat~dorm[,i]*dorm$Group, family="quasibinomial")
  print(summary(mymod))
  
}



####Plot it out
library(ggpmisc)
#plot including 3 treatments, ecological variable against dormancy probability
myplot = ggplot(dorm, aes(x = (bio9/10), y = Germination_rate, color = Group)) + geom_point() +
  stat_smooth(method = "glm", method.args = list(family=quasibinomial), se = TRUE) +
  scale_fill_manual('',values=c("#999999", "#E69F00", "#56B4E9")) + 
  scale_color_manual('',values=c("#999999", "#E69F00", "#56B4E9"), 
                     name="Group",
                     labels=c("Primary dormancy", "Secondary dormancy", "Control")) + 
  ggtitle("Germination and temperature of driest quarter")+
  xlab("Mean temperature of driest quarter") +
  ylab("Probability of germination") +
  theme_classic() +
  theme(plot.title=element_text(family = "Optima", face = "bold", size=13,hjust=0.5,vjust=1), 
        legend.position = "bottom", 
        legend.title = element_text(colour = "black", size = 11, family = "Optima"),
        legend.text = element_text(colour = "black", size = 11, family = "Optima"),
        axis.title.y = element_text(colour = 'black',  size = 11, family = "Optima", face= "bold", angle=90), 
        axis.title.x = element_text(colour = "black", size = 11, family = "Optima", face = "bold"),
        axis.text.x = element_text(colour = "black", size = 9, family = "Optima"),
        axis.text.y = element_text(colour = "black", size = 9, family = "Optima"))





#PCA for population structure examination
head(sdorm)
rownames(sdorm) <- NULL
par(mar=c(4,4,2,0.5))
pcaS <- prcomp(sdorm[,c(7:28)],center=T) #all bio factors
summary(pcaS)

biplot(pcaS) #biplot

plot(pcaS$sdev^2 / sum(pcaS$sdev^2), xlab="PC",
     ylab="Fraction Variation Explained", main="Scree plot") #scree plot
     
#pca plot with colours by countries

perc <- round(100*(pcaS$sdev^2 / sum(pcaS$sdev^2))[1:10],2)
names(perc) <- apply(array(seq(1,10,1)), 1, function(x){paste0("PC", x)})
perc
colors <- RColorBrewer::brewer.pal(9, "Paired")
par(mfrow=c(2,2), mar=c(4,4,0.5,0.5))
plot(pcaS$x[,1:2], col=colors[factor(unique(sdorm$Admixture))], pch=16,cex=1.2)
legend("bottomleft", legend=levels(factor(unique(sdorm$Admixture))), 
       col=colors, pch=16, ncol=3, cex=0.8)
plot(pcaS$x[,2:3], col=colors[factor(unique(sdorm$Admixture))], pch=16, cex=1.2)
plot(pcaS$x[,3:4], col=colors[factor(unique(sdorm$Admixture))], pch=16, cex=1.2)

#see more for biplot at https://www.benjaminbell.co.uk/2018/02/principal-components-analysis-pca-in-r.html


